pipeline {
    agent any

    environment {
        BASTION_IP = '54.246.137.197'
        PRIVATE_EC2_IP = '10.0.1.133'
        DEPLOY_DIR = '~/GroupAFruits-Veg-Market-One'
        SSH_CRED = 'AWS_SSH_KEY' // Jenkins private key stored as credential
    }

    stages {
        stage('Checkout Code') {
            steps { checkout scm }
        }

        stage('Prepare Dependencies') {
            steps {
                sh '''
                mkdir -p dependencies
                echo -e "fastapi\nuvicorn\nsqlalchemy\npsycopg[binary]" > backend-api/requirements.txt
                docker run --rm -v $(pwd):/app -w /app python:3.9 bash -c '
                    python -m pip install --upgrade pip
                    pip download -r backend-api/requirements.txt -d dependencies
                '
                '''
            }
        }

        stage('Deploy via Bastion') {
            steps {
                sshagent([env.SSH_CRED]) {
                    script {
                        // Save key for Jenkins shell
                        sh 'echo "$SSH_KEY" > private_key.pem && chmod 600 private_key.pem'

                        // Step 1: Copy all files to Bastion first
                        sh 'scp -o StrictHostKeyChecking=no -i private_key.pem -r ./ ec2-user@${BASTION_IP}:${DEPLOY_DIR}/'

                        // Step 2: From bastion, push to private EC2
                        sh """
                        ssh -i private_key.pem ec2-user@${BASTION_IP} '
                            scp -o StrictHostKeyChecking=no -r ${DEPLOY_DIR}/* ec2-user@${PRIVATE_EC2_IP}:${DEPLOY_DIR}/
                        '
                        """

                        // Step 3: Install dependencies & start service on private EC2
                        sh """
                        ssh -i private_key.pem ec2-user@${BASTION_IP} '
                            ssh -o StrictHostKeyChecking=no ec2-user@${PRIVATE_EC2_IP} "
                                cd ${DEPLOY_DIR}/backend-api
                                pip3 install --no-index --find-links=../dependencies -r requirements.txt
                                pkill uvicorn || true
                                nohup python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 > ../fastapi.log 2>&1 &
                            "
                        '
                        """
                    }
                }
            }
        }
    }

    post {
        success { echo 'Deployment completed successfully!' }
        failure { echo 'Deployment failed. Check logs for details.' }
    }
}
