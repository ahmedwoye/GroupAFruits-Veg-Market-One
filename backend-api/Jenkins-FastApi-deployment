pipeline {
    agent any

    environment {
        // Bastion (Public EC2 - Jump Host)
        BASTION_PUBLIC_IP = '3.252.82.226'

        // Private Backend EC2
        PRIVATE_EC2_IP = '10.0.3.201'

        // Deployment directory on private EC2
        DEPLOY_DIR = '/home/ec2-user/GroupAFruits-Veg-Market-One'

        // Jenkins SSH credential ID
        SSH_CRED = 'AWS_SSH_KEY'
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Prepare Dependencies') {
            steps {
                sh '''
                    mkdir -p dependencies

                    echo -e "fastapi
uvicorn
sqlalchemy
psycopg[binary]" > backend-api/requirements.txt

                    docker run --rm \
                        -v $(pwd):/app \
                        -w /app \
                        python:3.9 bash -c "
                            python -m pip install --upgrade pip
                            pip download -r backend-api/requirements.txt -d dependencies
                        "
                '''
            }
        }

        stage('Deploy Backend') {
            steps {
                sshagent([env.SSH_CRED]) {

                    // Step 1: Copy project to Private EC2 via Bastion
                    sh """
                        rsync -avz --delete \
                            --exclude '.git' \
                            -e "ssh -o StrictHostKeyChecking=no -J ec2-user@${BASTION_PUBLIC_IP}" \
                            ./ ec2-user@${PRIVATE_EC2_IP}:${DEPLOY_DIR}/
                    """

                    // Step 2: Install systemd service BEFORE backend deployment
                    sh """
                        ssh -o StrictHostKeyChecking=no \
                            -J ec2-user@${BASTION_PUBLIC_IP} \
                            ec2-user@${PRIVATE_EC2_IP} '

                            echo "Installing systemd service..."

                            sudo cp ${DEPLOY_DIR}/backend-api/fastapi.service \
                                /etc/systemd/system/fruit.service

                            sudo systemctl daemon-reload
                            sudo systemctl enable fruit.service
                            sudo systemctl restart fruit.service
                        '
                    """

                    // Step 3: Install dependencies
                    sh """
                        ssh -o StrictHostKeyChecking=no \
                            -J ec2-user@${BASTION_PUBLIC_IP} \
                            ec2-user@${PRIVATE_EC2_IP} '

                            cd ${DEPLOY_DIR}/backend-api

                            python3 -m venv venv || true
                            source venv/bin/activate

                            pip install --upgrade pip
                            pip install --no-cache-dir -r requirements.txt
                        '
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment completed successfully!'
        }
        failure {
            echo 'Deployment failed. Check logs for details.'
        }
    }
}
