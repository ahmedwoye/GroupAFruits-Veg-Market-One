pipeline {
    agent any

    environment {
        BASTION_PUBLIC_IP = '54.246.137.197'      // Bastion public IP
        PRIVATE_EC2_IP   = '10.0.4.152'          // Private EC2 IP
        DEPLOY_DIR       = '~/GroupAFruits-Veg-Market-One'
        SSH_CRED         = 'AWS_SSH_KEY'         // Jenkins stored private key credential
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Prepare Dependencies') {
            steps {
                sh '''
                    mkdir -p dependencies
                    echo -e "fastapi\nuvicorn\nsqlalchemy\npsycopg[binary]" > backend-api/requirements.txt
                    docker run --rm -v $(pwd):/app -w /app python:3.9 bash -c '
                        python -m pip install --upgrade pip
                        pip download -r backend-api/requirements.txt -d dependencies
                    '
                '''
            }
        }

        stage('Deploy to Private EC2 via Bastion') {
            steps {
                sshagent([env.SSH_CRED]) {
                    sh """
                        # Rsync directly to private EC2 using Bastion as jump host
                        rsync -avz --exclude '.git' -e "ssh -o StrictHostKeyChecking=no -J ec2-user@${BASTION_PUBLIC_IP}" ./ ec2-user@${PRIVATE_EC2_IP}:${DEPLOY_DIR}/

                        # Install dependencies & restart FastAPI
                        ssh -o StrictHostKeyChecking=no -J ec2-user@${BASTION_PUBLIC_IP} ec2-user@${PRIVATE_EC2_IP} '
                            cd ${DEPLOY_DIR}/backend-api
                            python3 -m venv venv
                            source venv/bin/activate
                            pip install --upgrade pip
                            pip install --no-index --find-links=../dependencies -r requirements.txt
                            pkill -f "uvicorn main:app" || true
                            nohup python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 > ../fastapi.log 2>&1 &
                        '
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment completed successfully!'
        }
        failure {
            echo 'Deployment failed. Check logs for details.'
        }
    }
}
