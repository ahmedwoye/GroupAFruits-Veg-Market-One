pipeline {
    agent any

    environment {
        BASTION_IP = '34.245.161.29'        // Public Bastion IP
        PRIVATE_EC2_IP = '10.0.1.133'      // Private EC2 IP
        DEPLOY_DIR = '~/GroupAFruits-Veg-Market-One'
        SSH_CRED = 'AWS_SSH_KEY'            // Jenkins private key credential ID
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Prepare & Download Dependencies (Docker)') {
            steps {
                script {
                    sh 'mkdir -p dependencies'
                    sh 'echo -e "fastapi\nuvicorn\nsqlalchemy\npsycopg[binary]" > backend-api/requirements.txt'

                    sh """
                        docker run --rm -v \$(pwd):/app -w /app python:3.9 bash -c '
                            python -m pip install --upgrade pip
                            pip download -r backend-api/requirements.txt -d dependencies
                        '
                    """
                }
            }
        }

        stage('Deploy via Bastion (SCP/SSH)') {
            steps {
                sshagent([env.SSH_CRED]) {
                    script {
                        // Save Jenkins private key to file
                        sh 'echo "$SSH_KEY" > private_key.pem && chmod 600 private_key.pem'

                        // Create SSH config for bastion and target EC2
                        writeFile file: 'ssh_config', text: """
Host bastion
    HostName ${BASTION_IP}
    User ec2-user
    IdentityFile private_key.pem
    StrictHostKeyChecking no
    UserKnownHostsFile=/dev/null

Host target
    HostName ${PRIVATE_EC2_IP}
    User ec2-user
    IdentityFile private_key.pem
    ProxyJump bastion
    StrictHostKeyChecking no
    UserKnownHostsFile=/dev/null
"""

                        // Create deployment folder on private EC2
                        sh 'ssh -F ssh_config target "mkdir -p ${DEPLOY_DIR}"'

                        // Copy entire workspace to private EC2 using rsync (safe & incremental)
                        sh 'rsync -avz -e "ssh -F ssh_config" ./ target:${DEPLOY_DIR}/'

                        // SSH to private EC2 and install dependencies + start FastAPI
                        sh """
                        ssh -F ssh_config target '
                            set -e
                            cd ${DEPLOY_DIR}/backend-api

                            # Install pip if missing
                            if ! command -v pip3 >/dev/null; then
                                sudo yum install -y python3-pip
                            fi

                            # Install Python dependencies from local folder
                            pip3 install --no-index --find-links=../dependencies -r requirements.txt

                            # Stop any existing uvicorn processes
                            pkill uvicorn || true

                            # Start FastAPI service in background
                            nohup python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 > ../fastapi.log 2>&1 &
                        '
                        """
                    }
                }
            }
        }
    }

    post {
        success { echo 'Deployment completed successfully!' }
        failure { echo 'Deployment failed. Check logs for details.' }
    }
}
