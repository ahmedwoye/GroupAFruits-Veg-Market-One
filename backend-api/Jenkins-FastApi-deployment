pipeline {
    agent any

    environment {
        REMOTE_USER = "ec2-user"
        REMOTE_HOST = "10.0.1.133"
        REMOTE_PATH = "~/GroupAFruits-Veg-Market-One"
        SSH_CRED = "AWS_SSH_KEY"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Prepare Dependencies') {
            steps {
                sh """
                    # Ensure python3 and pip3 exist on Jenkins host
                    python3 --version || sudo yum install python3 -y
                    python3 -m ensurepip --upgrade || true
                    python3 -m pip install --upgrade pip

                    # Download dependencies offline for deployment
                    mkdir -p dependencies
                    python3 -m pip download -r backend-api/requirements.txt -d dependencies
                """
            }
        }

        stage('Deploy to Private Backend') {
            steps {
                sshagent(credentials: ["${SSH_CRED}"]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} \\
                        "cd ${REMOTE_PATH}/backend-api && \\
                         # Create virtual environment if it does not exist
                         if [ ! -d venv ]; then python3 -m venv venv; fi && \\
                         source venv/bin/activate && \\
                         pip install --no-index --find-links=../dependencies -r requirements.txt && \\
                         # Reload and restart systemd service
                         sudo systemctl daemon-reload && \\
                         sudo systemctl restart fruit.service && \\
                         sudo systemctl status fruit.service"
                    """
                }
            }
        }
    }

    post {
        success {
            echo "Deployment completed successfully!"
        }
        failure {
            echo "Deployment failed! Check systemd service logs for errors."
        }
    }
}

