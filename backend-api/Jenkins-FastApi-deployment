pipeline {
    agent any

    environment {
        DEPENDENCY_DIR = "dependencies"
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Prepare & Download Dependencies (Docker)') {
            steps {
                script {
                    // Make sure dependencies folder exists
                    sh "mkdir -p ${DEPENDENCY_DIR}"

                    // Create requirements.txt if missing
                    sh '''
                        echo -e "fastapi\nuvicorn\nsqlalchemy\npsycopg[binary]" > backend-api/requirements.txt
                    '''

                    // Use Docker to download packages offline
                    sh """
                        docker run --rm -v \$(pwd):/app -w /app python:3.9 bash -c '
                            python -m pip install --upgrade pip
                            pip download -r backend-api/requirements.txt -d ${DEPENDENCY_DIR}
                        '
                    """
                }
            }
        }

        stage('Deploy to Private Backend (via Bastion)') {
            steps {
                sshagent(['AWS_SSH_KEY']) {
                    script {
                        sh """
                            # Create folder on private EC2 via Bastion
                            ssh -o StrictHostKeyChecking=no -J ec2-user@34.245.161.29 ec2-user@10.0.1.133 'mkdir -p ~/GroupAFruits-Veg-Market-One'

                            # Copy code + dependencies to private EC2 via Bastion
                            scp -o StrictHostKeyChecking=no -J ec2-user@34.245.161.29 -r ./* ec2-user@10.0.1.133:~/GroupAFruits-Veg-Market-One/

                            # Install packages and start FastAPI
                            ssh -o StrictHostKeyChecking=no -J ec2-user@34.245.161.29 ec2-user@10.0.1.133 '
                                cd ~/GroupAFruits-Veg-Market-One/backend-api
                                
                                # Install pip if missing
                                sudo yum install python3-pip -y

                                # Install dependencies offline
                                pip3 install --no-index --find-links=../${DEPENDENCY_DIR} -r requirements.txt

                                # Kill any running uvicorn
                                pkill uvicorn || true

                                # Start FastAPI
                                nohup python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 > ../fastapi.log 2>&1 &
                            '
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Deployment completed successfully!"
        }
        failure {
            echo "Deployment failed. Check Jenkins logs for details."
        }
    }
}
