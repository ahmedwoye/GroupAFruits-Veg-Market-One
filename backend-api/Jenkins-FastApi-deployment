pipeline {
    agent any

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Prepare Dependencies (Docker Clean Build)') {
            agent {
                docker {
                    image 'python:3.9'
                    args '-u root:root'
                }
            }
            steps {
                sh '''
                    python --version
                    pip --version

                    mkdir -p dependencies
                    pip download -r backend-api/requirements.txt -d dependencies
                '''
            }
        }

        stage('Deploy to Private Backend') {
            steps {
                sshagent(['AWS_SSH_KEY']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ec2-user@10.0.1.133 \
                        "mkdir -p ~/GroupAFruits-Veg-Market-One"

                        scp -o StrictHostKeyChecking=no -r * \
                        ec2-user@10.0.1.133:~/GroupAFruits-Veg-Market-One/

                        ssh -o StrictHostKeyChecking=no ec2-user@10.0.1.133 '
                            cd ~/GroupAFruits-Veg-Market-One/backend-api

                            sudo yum install -y python3 python3-pip

                            python3 -m pip install --upgrade pip

                            python3 -m pip install --no-index \
                              --find-links=../dependencies \
                              -r requirements.txt

                            pkill uvicorn || true

                            nohup python3 -m uvicorn main:app \
                              --host 0.0.0.0 \
                              --port 8000 \
                              > ../fastapi.log 2>&1 &
                        '
                    '''
                }
            }
        }
    }
}
