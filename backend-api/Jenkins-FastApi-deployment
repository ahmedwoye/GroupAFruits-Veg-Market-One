pipeline {
    agent any

    environment {
        BASTION_PUBLIC_IP = '3.252.82.226'
        PRIVATE_EC2_IP    = '10.0.3.201'
        APP_BASE_DIR      = '/home/ec2-user/apps'
        SSH_CRED          = 'AWS_SSH_KEY'
        APP_PORT          = '8000'
    }

    options {
        timestamps()
        disableConcurrentBuilds()
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Artifact') {
            steps {
                sh '''
                    mkdir -p artifact
                    rsync -av --exclude '.git' ./ artifact/
                '''
            }
        }

        stage('Deploy to Production') {
            steps {
                sshagent([env.SSH_CRED]) {
                    script {

                        def release = sh(
                            script: "date +%Y-%m-%d_%H-%M-%S",
                            returnStdout: true
                        ).trim()

                        sh """
                        ssh -o StrictHostKeyChecking=no \
                        -J ec2-user@${BASTION_PUBLIC_IP} \
                        ec2-user@${PRIVATE_EC2_IP} '

                            set -e

                            RELEASE_DIR=${APP_BASE_DIR}/releases/${release}
                            CURRENT_DIR=${APP_BASE_DIR}/current

                            echo "Creating release directory..."
                            mkdir -p \$RELEASE_DIR
                        '
                        """

                        // Copy artifact
                        sh """
                        rsync -avz --delete \
                            -e "ssh -o StrictHostKeyChecking=no -J ec2-user@${BASTION_PUBLIC_IP}" \
                            artifact/ ec2-user@${PRIVATE_EC2_IP}:${APP_BASE_DIR}/releases/${release}/
                        """

                        // Remote setup & atomic switch
                        sh """
                        ssh -o StrictHostKeyChecking=no \
                        -J ec2-user@${BASTION_PUBLIC_IP} \
                        ec2-user@${PRIVATE_EC2_IP} '

                            set -e

                            RELEASE_DIR=${APP_BASE_DIR}/releases/${release}
                            CURRENT_DIR=${APP_BASE_DIR}/current

                            cd \$RELEASE_DIR/backend-api

                            echo "Creating virtual environment..."
                            python3 -m venv venv || true
                            source venv/bin/activate

                            pip install --upgrade pip
                            pip install -r requirements.txt

                            echo "Installing systemd service..."
                            sudo cp fastapi.service /etc/systemd/system/fruit.service
                            sudo systemctl daemon-reload

                            echo "Switching symlink..."
                            ln -sfn \$RELEASE_DIR \$CURRENT_DIR

                            echo "Restarting service..."
                            sudo systemctl restart fruit.service
                        '
                        """

                        // Health check
                        sh """
                        echo "Running health check..."
                        sleep 5

                        ssh -o StrictHostKeyChecking=no \
                        -J ec2-user@${BASTION_PUBLIC_IP} \
                        ec2-user@${PRIVATE_EC2_IP} '
                            curl -f http://localhost:${APP_PORT}/docs > /dev/null
                        '
                        """
                    }
                }
            }
        }

        stage('Cleanup Old Releases') {
            steps {
                sshagent([env.SSH_CRED]) {
                    sh """
                    ssh -o StrictHostKeyChecking=no \
                    -J ec2-user@${BASTION_PUBLIC_IP} \
                    ec2-user@${PRIVATE_EC2_IP} '
                        cd ${APP_BASE_DIR}/releases
                        ls -dt */ | tail -n +6 | xargs -r rm -rf
                    '
                    """
                }
            }
        }
    }

    post {
        success {
            echo '✅ Deployment successful and verified!'
        }
        failure {
            echo '❌ Deployment failed! Manual investigation required.'
        }
    }
}
